<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SIPDe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #F7F7F7;
            color: #333333;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #1A3C5A;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: #FFFFFF;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header h1 i {
            color: #007BFF;
        }

        .filters {
            background: #1A3C5A;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: end;
            color: #FFFFFF;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 180px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select {
            padding: 10px 15px;
            border: 1px solid #FFFFFF;
            border-radius: 6px;
            background: #FFFFFF;
            color: #333333;
            font-weight: 500;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #007BFF;
        }

        .select2-container--default .select2-selection--multiple {
            border: 1px solid #FFFFFF;
            border-radius: 6px;
            background: #FFFFFF;
            padding: 8px 12px;
            min-height: 40px;
            color: #333333;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #007BFF;
            border: none;
            border-radius: 12px;
            color: #FFFFFF;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 4px 10px;
            margin: 2px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: #FFFFFF;
            font-weight: bold;
            margin-right: 6px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
            color: #E6F0FA;
        }

        .select2-dropdown {
            border: 1px solid #FFFFFF;
            border-radius: 6px;
            background: #FFFFFF;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #333333;
        }

        .filter-btn {
            background: #007BFF;
            color: #FFFFFF;
            border: none;
            padding: 12px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.3s ease;
        }

        .filter-btn:hover {
            background: #0056b3;
        }

        .reset-btn {
            background: #6C757D;
            color: #FFFFFF;
            border: none;
            padding: 12px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.3s ease;
        }

        .reset-btn:hover {
            background: #5A6268;
        }

        .stats-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .stat-card {
            background: #1A3C5A;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 200px;
            flex: 1;
            color: #FFFFFF;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            transition: transform 0.3s ease;
        }

        .stat-icon {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #007BFF;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #E6F0FA;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .growth-card-container {
            margin-bottom: 20px;
        }

        .growth-card {
            background: #1A3C5A;
            color: #FFFFFF;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .growth-card-content {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .growth-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .growth-title i {
            color: #007BFF;
            font-size: 1.8rem;
        }

        .growth-metrics {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .growth-metric {
            text-align: center;
        }

        .growth-metric-value {
            font-size: 2rem;
            font-weight: 600;
            color: #007BFF;
            margin-bottom: 5px;
        }

        .growth-metric-label {
            font-size: 0.9rem;
            color: #E6F0FA;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-section {
            background: #1A3C5A;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            color: #FFFFFF;
        }

        .map-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-title i {
            color: #007BFF;
        }

        .map-container {
            height: 500px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #FFFFFF;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #333333;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .pending-high { background-color: #DC3545; }
        .pending-medium { background-color: #FFC107; }
        .pending-low { background-color: #28A745; }
        .approved { background-color: #007BFF; }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1A3C5A;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: #FFFFFF;
        }

        .card:hover {
            transform: translateY(-2px);
            transition: transform 0.3s ease;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: #007BFF;
        }

        .chart-container {
            height: 320px;
            position: relative;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1A3C5A;
            border-radius: 8px;
            padding: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: #FFFFFF;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: #007BFF;
        }

        .modal-close {
            background: #6C757D;
            color: #FFFFFF;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .modal-close:hover {
            background: #5A6268;
        }

        .modal-chart-container {
            height: 400px;
            position: relative;
        }

        .modal-nominal {
            font-size: 1.1rem;
            margin-top: 15px;
            text-align: center;
        }

        .footer {
            background: #1A3C5A;
            color: #FFFFFF;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 1200px) {
            .growth-card-content {
                flex-direction: column;
                text-align: center;
            }
            
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .container {
                padding: 15px;
            }

            .stats-grid {
                flex-direction: column;
            }

            .stat-card {
                min-width: auto;
            }

            .growth-metrics {
                justify-content: center;
                gap: 15px;
            }

            .modal-content {
                width: 95%;
                max-height: 80%;
                padding: 15px;
            }
        }

        .animate-counter {
            animation: countUp 1.5s ease-out;
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .pulse-dot {
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            70% { transform: scale(1.2); opacity: 0.4; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Dashboard SIPDe</h1>
        </div>

        <!-- Filters - Only Periode (Tahun and Bulan) -->
        <div class="filters">
            <div class="filter-group">
                <label for="year-filter"><i class="fas fa-calendar"></i> Tahun</label>
                <select id="year-filter" class="multi-select" multiple>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="month-filter"><i class="fas fa-calendar-days"></i> Bulan</label>
                <select id="month-filter" class="multi-select" multiple>
                    <option value="1">Januari</option>
                    <option value="2">Februari</option>
                    <option value="3">Maret</option>
                    <option value="4">April</option>
                    <option value="5">Mei</option>
                    <option value="6">Juni</option>
                    <option value="7">Juli</option>
                    <option value="8">Agustus</option>
                    <option value="9">September</option>
                    <option value="10">Oktober</option>
                    <option value="11">November</option>
                    <option value="12">Desember</option>
                </select>
            </div>
            <button class="filter-btn" onclick="applyFilters()">
                <i class="fas fa-filter"></i> Filter Data
            </button>
            <button class="reset-btn" onclick="resetFilters()">
                <i class="fas fa-refresh"></i> Reset
            </button>
        </div>

        <!-- Statistics Cards - Added Dana Idle -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-value animate-counter" id="total-debtors">66</div>
                <div class="stat-label">Jumlah Debitur</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="stat-value animate-counter" id="total-plafond">9735.0M</div>
                <div class="stat-label">Jumlah Plafond</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-credit-card"></i></div>
                <div class="stat-value animate-counter" id="outstanding-debt">3877.5M</div>
                <div class="stat-label">Baki Debet</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                <div class="stat-value animate-counter" id="workforce">1,748</div>
                <div class="stat-label">Tenaga Kerja Terserap</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-area"></i></div>
                <div class="stat-value animate-counter" id="omset-projection">15%</div>
                <div class="stat-label">Proyeksi Omset Debitur</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                <div class="stat-value animate-counter" id="idle-funds">5000.0M</div>
                <div class="stat-label">Dana Idle</div>
            </div>
        </div>

        <!-- Dana Idle Card - Replaced Pertumbuhan Ekonomi -->
        <div class="growth-card-container">
            <div class="growth-card">
                <div class="growth-card-content">
                    <div class="growth-title">
                        <i class="fas fa-wallet"></i>
                        <span>Dana Idle (Ketersediaan Anggaran)</span>
                    </div>
                    <div class="growth-metrics">
                        <div class="growth-metric">
                            <div class="growth-metric-value">5000.0M</div>
                            <div class="growth-metric-label">Total Dana Idle</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Full Width Map with separate filters -->
        <div class="map-section">
            <div class="map-title">
                <i class="fas fa-map-marked-alt"></i> Persebaran Lokasi Pengajuan
            </div>
            <!-- Separate Filters for Map -->
            <div class="filters" style="margin-bottom: 15px;">
                <div class="filter-group">
                    <label for="map-year-filter"><i class="fas fa-calendar"></i> Tahun (Peta)</label>
                    <select id="map-year-filter" class="multi-select" multiple>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="map-month-filter"><i class="fas fa-calendar-days"></i> Bulan (Peta)</label>
                    <select id="map-month-filter" class="multi-select" multiple>
                        <option value="1">Januari</option>
                        <option value="2">Februari</option>
                        <option value="3">Maret</option>
                        <option value="4">April</option>
                        <option value="5">Mei</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">Agustus</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>
                </div>
                <button class="filter-btn" onclick="applyMapFilters()">
                    <i class="fas fa-filter"></i> Filter Peta
                </button>
                <button class="reset-btn" onclick="resetMapFilters()">
                    <i class="fas fa-refresh"></i> Reset Peta
                </button>
            </div>
            <div class="map-container" id="map"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color pending-high"></div>
                    <span>Pending Tinggi (>50)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color pending-medium"></div>
                    <span>Pending Sedang (20-50)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color pending-low"></div>
                    <span>Pending Rendah (<20)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color approved"></div>
                    <span>Terealisasi</span>
                </div>
            </div>
        </div>

        <!-- Charts Row - Only 2 General Charts -->
        <div class="charts-row">
            <!-- Debtor Categories (General 1) -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-pie-chart"></i> Kategori Debitur
                </div>
                <div class="chart-container">
                    <canvas id="debtorChart"></canvas>
                </div>
            </div>

            <!-- Pengajuan per Kabupaten/Kota (General 2) -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-building"></i> Pengajuan per Kabupaten/Kota
                </div>
                <div class="chart-container">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2025 Biro Perekonomian Provinsi Jawa Timur | Dashboard SIPDe</p>
            <p><i class="fas fa-envelope"></i> biro.perekonomian@jatimprov.go.id | <i class="fas fa-phone"></i> (031) 8283306</p>
        </div>
    </div>

    <!-- Modal for Sector Detail (Drilldown from Kategori Debitur) -->
    <div class="modal-overlay" id="sectorModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-industry"></i>
                    <span id="modalSectorTitle">Detail Sektor yang Dibiayai</span>
                </div>
                <button class="modal-close" onclick="closeSectorModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-chart-container">
                <canvas id="sectorDetailChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modal for Region Nominal (Drilldown from Pengajuan per Kabupaten/Kota) -->
    <div class="modal-overlay" id="regionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-money-bill-wave"></i>
                    <span id="modalRegionTitle">Detail Nominal Pengajuan</span>
                </div>
                <button class="modal-close" onclick="closeRegionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-nominal" id="modalNominalDetail"></div>
        </div>
    </div>

    <script>
        // Enhanced dummy data with more entries (100+ data points) - Added 'idleFunds' dummy field if needed
        const allData = [
            {id: 1, name: "PT Maju Bersama", amount: 75000000, status: "Pending", sector: "Perdagangan", region: "Surabaya", bank: "Bank Jatim", year: 2024, branch: "Cabang Surabaya Pusat", lat: -7.2575, lng: 112.7521, pendingCount: 85, workforce: 15, month: 1},
            {id: 2, name: "CV Berkah Surabaya", amount: 125000000, status: "Disetujui", sector: "Industri", region: "Surabaya", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Surabaya Pusat", lat: -7.2575, lng: 112.7521, pendingCount: 0, workforce: 25, month: 2},
            {id: 3, name: "UD Sumber Surabaya", amount: 45000000, status: "Pending", sector: "Pertanian", region: "Surabaya", bank: "Bank Jatim", year: 2023, branch: "Cabang Surabaya Pusat", lat: -7.2575, lng: 112.7521, pendingCount: 32, workforce: 8, month: 3},
            {id: 4, name: "Koperasi Jaya Surabaya", amount: 200000000, status: "Disetujui", sector: "Perikanan", region: "Surabaya", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Surabaya Pusat", lat: -7.2575, lng: 112.7521, pendingCount: 0, workforce: 35, month: 4},
            {id: 5, name: "PT Tech Surabaya", amount: 300000000, status: "Pending", sector: "Teknologi", region: "Surabaya", bank: "Bank Jatim", year: 2024, branch: "Cabang Surabaya Pusat", lat: -7.2575, lng: 112.7521, pendingCount: 67, workforce: 45, month: 5},
            {id: 6, name: "CV Digital Surabaya", amount: 150000000, status: "Disetujui", sector: "Teknologi", region: "Surabaya", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Surabaya Timur", lat: -7.2504, lng: 112.7688, pendingCount: 0, workforce: 28, month: 6},
            {id: 7, name: "UD Mandiri Surabaya", amount: 80000000, status: "Pending", sector: "Jasa", region: "Surabaya", bank: "Bank Jatim", year: 2023, branch: "Cabang Surabaya Barat", lat: -7.2383, lng: 112.7196, pendingCount: 18, workforce: 12, month: 7},
            {id: 8, name: "PT Konstruksi Surabaya", amount: 250000000, status: "Disetujui", sector: "Konstruksi", region: "Surabaya", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Surabaya Selatan", lat: -7.2819, lng: 112.7378, pendingCount: 0, workforce: 50, month: 8},
            {id: 9, name: "CV Berkah Sidoarjo", amount: 125000000, status: "Pending", sector: "Industri", region: "Sidoarjo", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Sidoarjo", lat: -7.4478, lng: 112.7183, pendingCount: 92, workforce: 22, month: 9},
            {id: 10, name: "PT Manufaktur Sidoarjo", amount: 180000000, status: "Disetujui", sector: "Industri", region: "Sidoarjo", bank: "Bank Jatim", year: 2024, branch: "Cabang Sidoarjo", lat: -7.4478, lng: 112.7183, pendingCount: 0, workforce: 40, month: 10},
            {id: 11, name: "UD Pertanian Sidoarjo", amount: 60000000, status: "Pending", sector: "Pertanian", region: "Sidoarjo", bank: "Bank UMKM Jatim", year: 2023, branch: "Cabang Sidoarjo", lat: -7.4478, lng: 112.7183, pendingCount: 28, workforce: 15, month: 11},
            {id: 12, name: "Koperasi Tani Sidoarjo", amount: 95000000, status: "Disetujui", sector: "Pertanian", region: "Sidoarjo", bank: "Bank Jatim", year: 2024, branch: "Cabang Sidoarjo", lat: -7.4478, lng: 112.7183, pendingCount: 0, workforce: 18, month: 12},
            {id: 13, name: "CV Logistik Sidoarjo", amount: 140000000, status: "Pending", sector: "Transportasi", region: "Sidoarjo", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Sidoarjo", lat: -7.4478, lng: 112.7183, pendingCount: 43, workforce: 25, month: 1},
            {id: 14, name: "UD Sumber Rejeki Malang", amount: 45000000, status: "Pending", sector: "Pertanian", region: "Malang", bank: "Bank Jatim", year: 2024, branch: "Cabang Malang", lat: -7.9666, lng: 112.6326, pendingCount: 67, workforce: 10, month: 2},
            {id: 15, name: "PT Wisata Malang", amount: 220000000, status: "Disetujui", sector: "Pariwisata", region: "Malang", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Malang", lat: -7.9666, lng: 112.6326, pendingCount: 0, workforce: 35, month: 3},
            {id: 16, name: "CV Kerajinan Malang", amount: 85000000, status: "Pending", sector: "Industri", region: "Malang", bank: "Bank Jatim", year: 2023, branch: "Cabang Malang", lat: -7.9666, lng: 112.6326, pendingCount: 34, workforce: 16, month: 4},
            {id: 17, name: "UD Kuliner Malang", amount: 55000000, status: "Disetujui", sector: "Perdagangan", region: "Malang", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Malang", lat: -7.9666, lng: 112.6326, pendingCount: 0, workforce: 12, month: 5},
            {id: 18, name: "Koperasi Petani Malang", amount: 75000000, status: "Pending", sector: "Pertanian", region: "Malang", bank: "Bank Jatim", year: 2024, branch: "Cabang Malang", lat: -7.9666, lng: 112.6326, pendingCount: 25, workforce: 14, month: 6},
            {id: 19, name: "PT Teknologi Gresik", amount: 300000000, status: "Pending", sector: "Teknologi", region: "Gresik", bank: "Bank Jatim", year: 2024, branch: "Cabang Gresik", lat: -7.1560, lng: 112.6535, pendingCount: 28, workforce: 42, month: 7},
            {id: 20, name: "CV Industri Gresik", amount: 190000000, status: "Disetujui", sector: "Industri", region: "Gresik", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Gresik", lat: -7.1560, lng: 112.6535, pendingCount: 0, workforce: 38, month: 8},
            {id: 21, name: "UD Perikanan Gresik", amount: 110000000, status: "Pending", sector: "Perikanan", region: "Gresik", bank: "Bank Jatim", year: 2023, branch: "Cabang Gresik", lat: -7.1560, lng: 112.6535, pendingCount: 19, workforce: 20, month: 9},
            {id: 22, name: "PT Kimia Gresik", amount: 350000000, status: "Disetujui", sector: "Industri", region: "Gresik", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Gresik", lat: -7.1560, lng: 112.6535, pendingCount: 0, workforce: 65, month: 10},
            {id: 23, name: "CV Harapan Pasuruan", amount: 80000000, status: "Pending", sector: "Jasa", region: "Pasuruan", bank: "Bank Jatim", year: 2024, branch: "Cabang Pasuruan", lat: -7.6453, lng: 112.9075, pendingCount: 15, workforce: 11, month: 11},
            {id: 24, name: "UD Tani Pasuruan", amount: 65000000, status: "Disetujui", sector: "Pertanian", region: "Pasuruan", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Pasuruan", lat: -7.6453, lng: 112.9075, pendingCount: 0, workforce: 13, month: 12},
            {id: 25, name: "PT Perdagangan Pasuruan", amount: 130000000, status: "Pending", sector: "Perdagangan", region: "Pasuruan", bank: "Bank Jatim", year: 2023, branch: "Cabang Pasuruan", lat: -7.6453, lng: 112.9075, pendingCount: 22, workforce: 24, month: 1},
            {id: 26, name: "CV Konstruksi Pasuruan", amount: 175000000, status: "Disetujui", sector: "Konstruksi", region: "Pasuruan", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Pasuruan", lat: -7.6453, lng: 112.9075, pendingCount: 0, workforce: 32, month: 2},
            {id: 27, name: "UD Sukses Mojokerto", amount: 60000000, status: "Pending", sector: "Konstruksi", region: "Mojokerto", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Mojokerto", lat: -7.4664, lng: 112.4341, pendingCount: 12, workforce: 9, month: 3},
            {id: 28, name: "PT Industri Mojokerto", amount: 160000000, status: "Disetujui", sector: "Industri", region: "Mojokerto", bank: "Bank Jatim", year: 2024, branch: "Cabang Mojokerto", lat: -7.4664, lng: 112.4341, pendingCount: 0, workforce: 28, month: 4},
            {id: 29, name: "CV Dagang Mojokerto", amount: 90000000, status: "Pending", sector: "Perdagangan", region: "Mojokerto", bank: "Bank UMKM Jatim", year: 2023, branch: "Cabang Mojokerto", lat: -7.4664, lng: 112.4341, pendingCount: 16, workforce: 15, month: 5},
            {id: 30, name: "Koperasi Jasa Mojokerto", amount: 70000000, status: "Disetujui", sector: "Jasa", region: "Mojokerto", bank: "Bank Jatim", year: 2024, branch: "Cabang Mojokerto", lat: -7.4664, lng: 112.4341, pendingCount: 0, workforce: 12, month: 6},
            {id: 31, name: "PT Sejahtera Kediri", amount: 150000000, status: "Disetujui", sector: "Perdagangan", region: "Kediri", bank: "Bank Jatim", year: 2024, branch: "Cabang Kediri", lat: -7.8484, lng: 112.0178, pendingCount: 0, workforce: 26, month: 7},
            {id: 32, name: "CV Agro Kediri", amount: 85000000, status: "Pending", sector: "Pertanian", region: "Kediri", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Kediri", lat: -7.8484, lng: 112.0178, pendingCount: 23, workforce: 16, month: 8},
            {id: 33, name: "UD Manufaktur Kediri", amount: 120000000, status: "Disetujui", sector: "Industri", region: "Kediri", bank: "Bank Jatim", year: 2023, branch: "Cabang Kediri", lat: -7.8484, lng: 112.0178, pendingCount: 0, workforce: 22, month: 9},
            {id: 34, name: "PT Teknologi Kediri", amount: 200000000, status: "Pending", sector: "Teknologi", region: "Kediri", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Kediri", lat: -7.8484, lng: 112.0178, pendingCount: 31, workforce: 35, month: 10},
            {id: 35, name: "CV Makmur Jember", amount: 90000000, status: "Disetujui", sector: "Pertanian", region: "Jember", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Jember", lat: -8.1844, lng: 113.7094, pendingCount: 0, workforce: 17, month: 11},
            {id: 36, name: "PT Perdagangan Jember", amount: 135000000, status: "Pending", sector: "Perdagangan", region: "Jember", bank: "Bank Jatim", year: 2024, branch: "Cabang Jember", lat: -8.1844, lng: 113.7094, pendingCount: 27, workforce: 25, month: 12},
            {id: 37, name: "UD Kopi Jember", amount: 75000000, status: "Disetujui", sector: "Pertanian", region: "Jember", bank: "Bank UMKM Jatim", year: 2023, branch: "Cabang Jember", lat: -8.1844, lng: 113.7094, pendingCount: 0, workforce: 14, month: 1},
            {id: 38, name: "CV Industri Jember", amount: 165000000, status: "Pending", sector: "Industri", region: "Jember", bank: "Bank Jatim", year: 2024, branch: "Cabang Jember", lat: -8.1844, lng: 113.7094, pendingCount: 38, workforce: 30, month: 2},
            {id: 39, name: "Koperasi Mitra Banyuwangi", amount: 200000000, status: "Pending", sector: "Perikanan", region: "Banyuwangi", bank: "Bank UMKM Jatim", year: 2023, branch: "Cabang Banyuwangi", lat: -8.2192, lng: 114.3691, pendingCount: 34, workforce: 36, month: 3},
            {id: 40, name: "PT Wisata Banyuwangi", amount: 280000000, status: "Disetujui", sector: "Pariwisata", region: "Banyuwangi", bank: "Bank Jatim", year: 2024, branch: "Cabang Banyuwangi", lat: -8.2192, lng: 114.3691, pendingCount: 0, workforce: 48, month: 4},
            {id: 41, name: "CV Nelayan Banyuwangi", amount: 110000000, status: "Pending", sector: "Perikanan", region: "Banyuwangi", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Banyuwangi", lat: -8.2192, lng: 114.3691, pendingCount: 19, workforce: 22, month: 5},
            {id: 42, name: "UD Kerajinan Banyuwangi", amount: 65000000, status: "Disetujui", sector: "Industri", region: "Banyuwangi", bank: "Bank Jatim", year: 2024, branch: "Cabang Banyuwangi", lat: -8.2192, lng: 114.3691, pendingCount: 0, workforce: 13, month: 6},
            {id: 43, name: "Koperasi Tani Probolinggo", amount: 70000000, status: "Disetujui", sector: "Perikanan", region: "Probolinggo", bank: "Bank Jatim", year: 2024, branch: "Cabang Probolinggo", lat: -7.7543, lng: 113.2159, pendingCount: 0, workforce: 15, month: 7},
            {id: 44, name: "PT Agro Probolinggo", amount: 125000000, status: "Pending", sector: "Pertanian", region: "Probolinggo", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Probolinggo", lat: -7.7543, lng: 113.2159, pendingCount: 24, workforce: 23, month: 8},
            {id: 45, name: "CV Perdagangan Probolinggo", amount: 95000000, status: "Disetujui", sector: "Perdagangan", region: "Probolinggo", bank: "Bank Jatim", year: 2023, branch: "Cabang Probolinggo", lat: -7.7543, lng: 113.2159, pendingCount: 0, workforce: 18, month: 9},
            {id: 46, name: "UD Industri Probolinggo", amount: 145000000, status: "Pending", sector: "Industri", region: "Probolinggo", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Probolinggo", lat: -7.7543, lng: 113.2159, pendingCount: 29, workforce: 27, month: 10},
            {id: 47, name: "PT Digital Surabaya 2", amount: 180000000, status: "Ditolak", sector: "Teknologi", region: "Surabaya", bank: "Bank Jatim", year: 2022, branch: "Cabang Surabaya Pusat", lat: -7.2680, lng: 112.7400, pendingCount: 0, workforce: 0, month: 11},
            {id: 48, name: "CV Ekspor Sidoarjo", amount: 320000000, status: "Disetujui", sector: "Perdagangan", region: "Sidoarjo", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Sidoarjo", lat: -7.4500, lng: 112.7200, pendingCount: 0, workforce: 55, month: 12},
            {id: 49, name: "UD Hortikultura Malang", amount: 85000000, status: "Pending", sector: "Pertanian", region: "Malang", bank: "Bank Jatim", year: 2024, branch: "Cabang Malang", lat: -7.9700, lng: 112.6400, pendingCount: 21, workforce: 16, month: 1},
            {id: 50, name: "PT Petrokimia Gresik", amount: 450000000, status: "Disetujui", sector: "Industri", region: "Gresik", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Gresik", lat: -7.1600, lng: 112.6600, pendingCount: 0, workforce: 85, month: 2},
            {id: 51, name: "CV Retail Pasuruan", amount: 95000000, status: "Pending", sector: "Perdagangan", region: "Pasuruan", bank: "Bank Jatim", year: 2024, branch: "Cabang Pasuruan", lat: -7.6500, lng: 112.9100, pendingCount: 18, workforce: 19, month: 3},
            {id: 52, name: "UD Logistik Mojokerto", amount: 110000000, status: "Disetujui", sector: "Transportasi", region: "Mojokerto", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Mojokerto", lat: -7.4700, lng: 112.4400, pendingCount: 0, workforce: 21, month: 4},
            {id: 53, name: "PT Software Kediri", amount: 175000000, status: "Pending", sector: "Teknologi", region: "Kediri", bank: "Bank Jatim", year: 2024, branch: "Cabang Kediri", lat: -7.8500, lng: 112.0200, pendingCount: 26, workforce: 32, month: 5},
            {id: 54, name: "CV Tembakau Jember", amount: 140000000, status: "Disetujui", sector: "Pertanian", region: "Jember", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Jember", lat: -8.1900, lng: 113.7200, pendingCount: 0, workforce: 28, month: 6},
            {id: 55, name: "UD Batik Banyuwangi", amount: 75000000, status: "Pending", sector: "Industri", region: "Banyuwangi", bank: "Bank Jatim", year: 2023, branch: "Cabang Banyuwangi", lat: -8.2200, lng: 114.3700, pendingCount: 14, workforce: 15, month: 7},
            {id: 56, name: "PT Mangga Probolinggo", amount: 105000000, status: "Disetujui", sector: "Pertanian", region: "Probolinggo", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Probolinggo", lat: -7.7600, lng: 113.2200, pendingCount: 0, workforce: 20, month: 8},
            {id: 57, name: "CV Startup Surabaya", amount: 250000000, status: "Pending", sector: "Teknologi", region: "Surabaya", bank: "Bank Jatim", year: 2025, branch: "Cabang Surabaya Pusat", lat: -7.2600, lng: 112.7550, pendingCount: 45, workforce: 38, month: 9},
            {id: 58, name: "UD Furniture Sidoarjo", amount: 135000000, status: "Disetujui", sector: "Industri", region: "Sidoarjo", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Sidoarjo", lat: -7.4400, lng: 112.7100, pendingCount: 0, workforce: 26, month: 10},
            {id: 59, name: "PT Apel Malang", amount: 88000000, status: "Pending", sector: "Pertanian", region: "Malang", bank: "Bank Jatim", year: 2024, branch: "Cabang Malang", lat: -7.9600, lng: 112.6300, pendingCount: 17, workforce: 17, month: 11},
            {id: 60, name: "CV Semen Gresik", amount: 380000000, status: "Disetujui", sector: "Industri", region: "Gresik", bank: "Bank UMKM Jatim", year: 2024, branch: "Cabang Gresik", lat: -7.1500, lng: 112.6500, pendingCount: 0, workforce: 72, month: 12},
        ];

        let filteredData = [...allData];
        let mapFilteredData = [...allData];
        let map;
        let charts = {};
        let markers = [];
        let markerLayer = L.layerGroup();

        // Logo URLs
        const bankJatimLogo = './assets/bank-jatim.png';
        const bankUmkmLogo = './assets/bank-bpr.png';

        // Month names for timeline
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];

        // Generate sector detail data for a specific category
        function generateSectorDetailData(category) {
            const sectorCounts = {};
            filteredData.filter(item => getCategory(item.amount) === category).forEach(item => {
                sectorCounts[item.sector] = (sectorCounts[item.sector] || 0) + 1;
            });
            return { labels: Object.keys(sectorCounts), data: Object.values(sectorCounts) };
        }

        // Helper to get category from amount
        function getCategory(amount) {
            if (amount <= 50000000) return '0-50 Juta';
            else if (amount <= 100000000) return '>50-100 Juta';
            else if (amount <= 300000000) return '>100-300 Juta';
            else return '>300 Juta';
        }

        // Show sector detail modal (drilldown from kategori debitur)
        function showSectorDetail(category) {
            document.getElementById('modalSectorTitle').textContent = `Detail Sektor untuk Kategori ${category}`;
            document.getElementById('sectorModal').style.display = 'block';
            document.body.style.overflow = 'hidden';

            const { labels, data } = generateSectorDetailData(category);

            const ctx = document.getElementById('sectorDetailChart').getContext('2d');

            if (charts.sectorDetail) {
                charts.sectorDetail.destroy();
            }

            charts.sectorDetail = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#007BFF', '#DC3545', '#FFC107', '#28A745', 
                            '#6C757D', '#17A2B8', '#343A40', '#E6F0FA'
                        ],
                        borderColor: '#FFFFFF',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 10,
                                font: {
                                    size: 11,
                                    weight: '500',
                                    color: '#FFFFFF'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Close sector detail modal
        function closeSectorModal() {
            document.getElementById('sectorModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            if (charts.sectorDetail) {
                charts.sectorDetail.destroy();
                charts.sectorDetail = null;
            }
        }

        // Show region nominal modal (drilldown from region chart)
        function showRegionNominal(region, total, realized, rejected) {
            document.getElementById('modalRegionTitle').textContent = `Detail Nominal untuk ${region}`;
            document.getElementById('modalNominalDetail').innerHTML = `
                <p><strong>Total Pengajuan:</strong> Rp ${total.toLocaleString('id-ID')}</p>
                <p><strong>Terealisasi:</strong> Rp ${realized.toLocaleString('id-ID')} (Hijau)</p>
                <p><strong>Ditolak:</strong> Rp ${rejected.toLocaleString('id-ID')} (Merah)</p>
            `;
            document.getElementById('regionModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Close region nominal modal
        function closeRegionModal() {
            document.getElementById('regionModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Initialize Map with locked bounds to Jawa Timur
        function initMap() {
            map = L.map('map', {
                maxBounds: L.latLngBounds(L.latLng(-8.5, 111.0), L.latLng(-6.0, 115.0)), // Batas Jawa Timur
                maxBoundsViscosity: 1.0, // Mencegah peta digeser keluar dari batas
                minZoom: 7, // Zoom minimum untuk memastikan fokus pada Jawa Timur
                maxZoom: 12 // Zoom maksimum untuk detail yang wajar
            }).setView([-7.8, 112.5], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            markerLayer.addTo(map);

            map.on('zoomend', function() {
                updateMapMarkers();
            });

            updateMapMarkers();
        }

        function updateMapMarkers() {
            markerLayer.clearLayers();

            if (map.getZoom() < 10) {
                return; // Don't show markers if zoom is less than 10
            }

            // Aggregate data per branch
            const branchData = {};
            mapFilteredData.forEach(item => {
                const branch = item.branch;
                if (!branchData[branch]) {
                    branchData[branch] = {
                        bank: item.bank,
                        region: item.region,
                        lat: item.lat,
                        lng: item.lng,
                        debitur: 0,
                        plafond: 0,
                        bakiDebet: 0,
                        workforce: 0,
                        pendingCount: 0,
                        years: new Set()
                    };
                }
                branchData[branch].debitur += 1;
                branchData[branch].plafond += item.amount;
                if (item.status === 'Disetujui') {
                    branchData[branch].bakiDebet += item.amount * 0.75; // Assuming 75% for baki debet
                }
                branchData[branch].workforce += item.workforce;
                branchData[branch].pendingCount += item.pendingCount;
                branchData[branch].years.add(item.year);
            });

            // Add markers for each branch
            Object.entries(branchData).forEach(([branch, data]) => {
                const iconUrl = data.bank === 'Bank Jatim' ? bankJatimLogo : bankUmkmLogo;
                const customIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -40]
                });

                const marker = L.marker([data.lat, data.lng], { icon: customIcon });

                marker.bindPopup(`
                    <div style="font-family: 'Arial', sans-serif; padding: 5px; color: #333;">
                        <h4 style="margin: 0 0 8px 0; color: #1A3C5A; font-size: 14px;">${branch}</h4>
                        <div style="font-size: 12px; line-height: 1.6;">
                            <p style="margin: 3px 0;"><strong>Nominal:</strong> Rp ${data.plafond.toLocaleString('id-ID')}</p>
                            <p style="margin: 3px 0;"><strong>Jumlah Debitur:</strong> ${data.debitur}</p>
                            <p style="margin: 3px 0;"><strong>Jumlah Plafond:</strong> Rp ${data.plafond.toLocaleString('id-ID')}</p>
                            <p style="margin: 3px 0;"><strong>Baki Debet:</strong> Rp ${data.bakiDebet.toLocaleString('id-ID')}</p>
                            <p style="margin: 3px 0;"><strong>Wilayah:</strong> ${data.region}</p>
                            <p style="margin: 3px 0;"><strong>Tenaga Kerja:</strong> ${data.workforce} orang</p>
                            <p style="margin: 3px 0;"><strong>Tahun:</strong> ${Array.from(data.years).join(', ')}</p>
                            <p style="margin: 3px 0;"><strong>Pending Count:</strong> ${data.pendingCount}</p>
                        </div>
                    </div>
                `, {
                    maxWidth: 250,
                    className: 'custom-popup'
                });

                markerLayer.addLayer(marker);
            });
        }

        // Calculate statistics from filtered data (added idle funds dummy calculation)
        function calculateStats() {
            const totalDebtors = filteredData.length;
            const totalPlafond = filteredData.reduce((sum, item) => sum + item.amount, 0);
            const totalWorkforce = filteredData.reduce((sum, item) => sum + item.workforce, 0);
            const approvedData = filteredData.filter(item => item.status === 'Disetujui');
            const outstandingDebt = approvedData.reduce((sum, item) => sum + (item.amount * 0.75), 0);
            const idleFunds = 5000000000 - totalPlafond;

            return {
                totalDebtors,
                totalPlafond: (totalPlafond / 1000000).toFixed(1) + 'M',
                outstandingDebt: (outstandingDebt / 1000000).toFixed(1) + 'M',
                totalWorkforce: totalWorkforce.toLocaleString('id-ID'),
                idleFunds: (idleFunds / 1000000).toFixed(1) + 'M'
            };
        }

        // Update statistics display
        function updateStats() {
            const stats = calculateStats();
            
            document.getElementById('total-debtors').textContent = stats.totalDebtors.toLocaleString('id-ID');
            document.getElementById('total-plafond').textContent = stats.totalPlafond;
            document.getElementById('outstanding-debt').textContent = stats.outstandingDebt;
            document.getElementById('workforce').textContent = stats.totalWorkforce;
            document.getElementById('idle-funds').textContent = stats.idleFunds;
        }

        // Get chart data based on filtered data
        function getChartData() {
            const sectorCounts = {};
            const regionCounts = {};
            const regionRealized = {};
            const regionRejected = {};
            const categories = {'0-50 Juta': 0, '>50-100 Juta': 0, '>100-300 Juta': 0, '>300 Juta': 0};
            const regionTotalNominal = {};
            const regionRealizedNominal = {};
            const regionRejectedNominal = {};

            filteredData.forEach(item => {
                sectorCounts[item.sector] = (sectorCounts[item.sector] || 0) + 1;
                regionCounts[item.region] = (regionCounts[item.region] || 0) + 1;
                regionTotalNominal[item.region] = (regionTotalNominal[item.region] || 0) + item.amount;
                
                if (item.status === 'Disetujui') {
                    regionRealized[item.region] = (regionRealized[item.region] || 0) + 1;
                    regionRealizedNominal[item.region] = (regionRealizedNominal[item.region] || 0) + item.amount;
                } else if (item.status === 'Ditolak') {
                    regionRejected[item.region] = (regionRejected[item.region] || 0) + 1;
                    regionRejectedNominal[item.region] = (regionRejectedNominal[item.region] || 0) + item.amount;
                }
                
                if (item.amount <= 50000000) categories['0-50 Juta']++;
                else if (item.amount <= 100000000) categories['>50-100 Juta']++;
                else if (item.amount <= 300000000) categories['>100-300 Juta']++;
                else categories['>300 Juta']++;
            });

            return { 
                sectorCounts, 
                regionCounts, 
                regionRealized, 
                regionRejected, 
                categories,
                regionTotalNominal,
                regionRealizedNominal,
                regionRejectedNominal 
            };
        }

        // Initialize all charts
        function initCharts() {
            updateCharts();
        }

        function updateCharts() {
            const chartData = getChartData();

            Object.keys(charts).forEach(key => {
                if (charts[key] && key !== 'sectorDetail') {
                    charts[key].destroy();
                }
            });

            const debtorCtx = document.getElementById('debtorChart').getContext('2d');
            const categoryData = Object.values(chartData.categories);
            const categoryLabels = Object.keys(chartData.categories);
            
            charts.debtor = new Chart(debtorCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: [
                            '#007BFF',
                            '#DC3545',
                            '#FFC107',
                            '#28A745'
                        ],
                        borderColor: '#FFFFFF',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 10,
                                font: {
                                    size: 11,
                                    weight: '500',
                                    color: '#FFFFFF'
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const dataIndex = activeElements[0].index;
                            const category = categoryLabels[dataIndex];
                            showSectorDetail(category);
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            const regionCtx = document.getElementById('regionChart').getContext('2d');
            const regionLabels = Object.keys(chartData.regionCounts);
            const totalData = regionLabels.map(region => chartData.regionCounts[region]);
            const realizedData = regionLabels.map(region => chartData.regionRealized[region] || 0);
            const rejectedData = regionLabels.map(region => chartData.regionRejected[region] || 0);
            
            charts.region = new Chart(regionCtx, {
                type: 'bar',
                data: {
                    labels: regionLabels,
                    datasets: [
                        {
                            label: 'Total',
                            data: totalData,
                            backgroundColor: '#007BFF',
                            borderColor: '#FFFFFF',
                            borderWidth: 2
                        },
                        {
                            label: 'Terealisasi',
                            data: realizedData,
                            backgroundColor: '#28A745',
                            borderColor: '#FFFFFF',
                            borderWidth: 2
                        },
                        {
                            label: 'Ditolak',
                            data: rejectedData,
                            backgroundColor: '#DC3545',
                            borderColor: '#FFFFFF',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 10,
                                font: {
                                    size: 11,
                                    weight: '500',
                                    color: '#FFFFFF'
                                }
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const dataIndex = activeElements[0].index;
                            const region = regionLabels[dataIndex];
                            const total = chartData.regionTotalNominal[region] || 0;
                            const realized = chartData.regionRealizedNominal[region] || 0;
                            const rejected = chartData.regionRejectedNominal[region] || 0;
                            showRegionNominal(region, total, realized, rejected);
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        // Filter logic
        function applyFilters() {
            const years = $('#year-filter').val() || [];
            const months = $('#month-filter').val() || [];
            filteredData = allData.filter(item => {
                const yearMatch = years.length === 0 || years.includes(item.year.toString());
                const monthMatch = months.length === 0 || months.includes(item.month.toString());
                return yearMatch && monthMatch;
            });
            updateStats();
            updateCharts();
        }

        function resetFilters() {
            $('#year-filter').val(null).trigger('change');
            $('#month-filter').val(null).trigger('change');
            filteredData = [...allData];
            updateStats();
            updateCharts();
        }

        // Map filter logic
        function applyMapFilters() {
            const years = $('#map-year-filter').val() || [];
            const months = $('#map-month-filter').val() || [];
            mapFilteredData = allData.filter(item => {
                const yearMatch = years.length === 0 || years.includes(item.year.toString());
                const monthMatch = months.length === 0 || months.includes(item.month.toString());
                return yearMatch && monthMatch;
            });
            updateMapMarkers();
        }

        function resetMapFilters() {
            $('#map-year-filter').val(null).trigger('change');
            $('#map-month-filter').val(null).trigger('change');
            mapFilteredData = [...allData];
            updateMapMarkers();
        }

        // Counter animation
        function animateCounters() {
            document.querySelectorAll('.stat-value').forEach(el => {
                el.classList.remove('animate-counter');
                void el.offsetWidth;
                el.classList.add('animate-counter');
            });
        }

        // Select2 initialization
        $(document).ready(function() {
            $('.multi-select').select2({
                width: '100%',
                placeholder: 'Pilih',
                allowClear: true
            });

            initMap();
            updateStats();
            initCharts();

            // Event listeners for filter buttons
            document.querySelector('.filter-btn').addEventListener('click', applyFilters);
            document.querySelector('.reset-btn').addEventListener('click', resetFilters);

            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    closeSectorModal();
                    closeRegionModal();
                });
            });

            // Prevent modal close when clicking inside modal content
            document.querySelectorAll('.modal-content').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });

            // Close modal when clicking overlay
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        overlay.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        if (charts.sectorDetail) {
                            charts.sectorDetail.destroy();
                            charts.sectorDetail = null;
                        }
                    }
                });
            });

            // Initial animation for stats
            animateCounters();
        });
    </script>
</body>
</html>